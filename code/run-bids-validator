#!/bin/bash
# Run BIDS validator on this study dataset
# Usage: datalad run code/run-bids-validator
#
# Outputs are stored in derivatives/bids-validator/:
#   version.txt  - Validator version
#   report.json  - Machine-readable results (--json)
#   report.txt   - Human-readable output

set -eu

# Output directory
od=derivatives/bids-validator

# Command to run (prefer uvx for speed)
if command -v uvx >/dev/null 2>&1; then
    cmd="uvx bids-validator-deno"
elif command -v bids-validator-deno >/dev/null 2>&1; then
    cmd="bids-validator-deno"
elif command -v deno >/dev/null 2>&1; then
    cmd="deno run --allow-read --allow-env jsr:@bids/validator"
elif command -v npx >/dev/null 2>&1; then
    cmd="npx -y bids-validator"
else
    echo "Error: No BIDS validator found. Install with: uv tool install bids-validator-deno"
    exit 1
fi

# Create output directory
mkdir -p "$od"

# Save validator version
$cmd --version > "$od/version.txt" 2>&1 || echo "unknown" > "$od/version.txt"

# Run validation with JSON output
$cmd --json . > "$od/report.json" 2>&1 || true

# Run validation with text output
$cmd . > "$od/report.txt" 2>&1 || true
