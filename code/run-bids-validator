#!/bin/bash
# Run BIDS validator on this study dataset
# Usage: datalad run code/run-bids-validator
#
# Outputs are stored in derivatives/bids-validator/:
#   version.txt  - Validator version
#   report.json  - Machine-readable results
#   report.txt   - Human-readable summary

set -eu

# Output directory
od=derivatives/bids-validator

# Command to run (prefer uvx for speed)
if command -v uvx >/dev/null 2>&1; then
    cmd="uvx bids-validator-deno"
elif command -v bids-validator-deno >/dev/null 2>&1; then
    cmd="bids-validator-deno"
elif command -v deno >/dev/null 2>&1; then
    cmd="deno run --allow-read --allow-env jsr:@bids/validator"
elif command -v npx >/dev/null 2>&1; then
    cmd="npx -y bids-validator"
else
    echo "Error: No BIDS validator found. Install with: uv tool install bids-validator-deno"
    exit 1
fi

# Create output directory
mkdir -p "$od"

# Save validator version
$cmd --version > "$od/version.txt" 2>&1 || echo "unknown" > "$od/version.txt"

# Run validation with JSON output
echo "Running BIDS validation..."
$cmd --json . > "$od/report.json" 2>&1 || true

# Generate text summary
{
    echo "BIDS Validation Summary"
    echo "============================================================"
    echo ""

    if [ -f "$od/report.json" ]; then
        # Extract error and warning counts from JSON
        errors=$(jq -r '.issues.errors | length // 0' "$od/report.json" 2>/dev/null || echo "0")
        warnings=$(jq -r '.issues.warnings | length // 0' "$od/report.json" 2>/dev/null || echo "0")

        echo "Errors: $errors"
        echo "Warnings: $warnings"
        echo ""

        if [ "$errors" = "0" ] && [ "$warnings" = "0" ]; then
            echo "Dataset is BIDS valid!"
        fi
    else
        echo "No JSON output available"
    fi

    echo ""
    echo "Validator version: $(cat "$od/version.txt")"
} > "$od/report.txt"

echo "Validation complete. Results in $od/"
